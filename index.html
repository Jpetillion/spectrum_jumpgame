<!doctype html>
<html lang="nl">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TCD6VL864B"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-TCD6VL864B');
    </script>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Pixel Jump - free game</title>
    <style>
      :root {
        --hud-bg: rgba(0,0,0,.55);
        --hud-border: #3a3a3a;
        --hud-text: #ffffff;
        --hint-text: #e6e6e6;

        /* Spectrum-blauw */
        --brand-1: #111525;
        --brand-2: #2b2f55;
        --brand-3: #8aa3ff;
        --brand-4: #cfe0ff;
      }
      html, body { margin: 0; padding: 0; background: #0a0a0a; color: #e6e6e6; font-family: monospace; }
      #hud {
        position: fixed; top: 10px; left: 10px;
        background: var(--hud-bg); padding: 8px 12px;
        border: 1px solid var(--hud-border); border-radius: 6px; z-index: 5;
        color: var(--hud-text); text-shadow: 0 2px 4px rgba(0,0,0,0.6);
        -webkit-font-smoothing: antialiased; font-weight: 600;
      }
      canvas { display: block; margin: 0 auto; background: linear-gradient(#0a0a0a, #0d0f1a); width: 100vw; height: 100vh; }
      #hint { position: fixed; bottom: 12px; left: 50%; transform: translateX(-50%); opacity: .9; font-size: 14px; z-index: 3; color: var(--hint-text); text-shadow: 0 2px 4px rgba(0,0,0,0.7); }

      /* === Game Over overlay === */
      #gameover {
        position: fixed; inset: 0; display: none; place-items: center; z-index: 6;
        background: rgba(0,0,0,0.7);
      }
      #gameover .card {
        text-align: center; padding: 18px 20px; border: 1px solid #5a5f8e; border-radius: 12px;
        background: #111525; box-shadow: 0 10px 36px rgba(0,0,0,0.55);
        max-width: min(92vw, 620px); color: #ffffff;
      }
      #gameover h1 { margin: 0 0 8px; font-size: 32px; letter-spacing: 1px; text-shadow: 0 3px 8px rgba(0,0,0,.8); }
      #gameover p  { margin: 6px 0; font-size: 16px; opacity: .95; }
      #gameover .score { font-size: 20px; margin-top: 4px; font-weight: 700; }

      .cta-opleiding {
        display: inline-block; margin-top: 12px; padding: 10px 14px; cursor: pointer;
        background: linear-gradient(135deg,#6ea8ff,#8aa3ff 40%,#b1c6ff);
        color:#0b1020; border: 1px solid #cfe0ff; border-radius: 10px;
        font-weight: 800; text-decoration: none; letter-spacing:.2px;
        box-shadow: 0 8px 20px rgba(138,163,255,.25), inset 0 -2px 0 rgba(0,0,0,.15);
        transition: transform .08s ease, box-shadow .2s ease;
      }
      .cta-opleiding:hover { transform: translateY(-1px); box-shadow: 0 10px 26px rgba(138,163,255,.32), inset 0 -2px 0 rgba(0,0,0,.18); }

      #gameover a.minibtn, #gameover button.minibtn {
        display:inline-block; margin-top:10px; padding:8px 12px; cursor:pointer;
        background:#2b2f55; border:1px solid #8aa3ff; border-radius:6px; color:#fff; text-decoration:none;
        transition: transform .05s ease;
      }
      #gameover a.minibtn:hover, #gameover button.minibtn:hover { transform: translateY(-1px); }

      .tagbar { margin-top: 12px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
      .chip {
        padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px;
        border:1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06);
      }
      .chip.c1{ background:rgba(255,107,107,.18); border-color:rgba(255,107,107,.35);}
      .chip.c2{ background:rgba(130,170,255,.18); border-color:rgba(130,170,255,.35);}
      .chip.c3{ background:rgba(122,255,193,.18); border-color:rgba(122,255,193,.35);}
      .chip.c4{ background:rgba(255,214,102,.18); border-color:rgba(255,214,102,.35);}
      .chip.c5{ background:rgba(200,130,255,.18); border-color:rgba(200,130,255,.35);}

      #gameover .hint { margin-top: 12px; font-size: 14px; opacity: .85; }

      #rec {
        position: fixed; top: 10px; right: 12px; z-index: 5; display: none;
        font-weight: 700; color: #fff; text-shadow: 0 2px 6px rgba(0,0,0,.7);
        background: rgba(0,0,0,.45); padding: 6px 10px; border: 1px solid rgba(255,255,255,.2); border-radius: 6px;
      }
      #rec .dot {
        display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: #ff3b3b;
        margin-right: 6px; box-shadow: 0 0 8px rgba(255,59,59,.9), 0 0 14px rgba(255,59,59,.7);
        animation: blink 1s infinite;
      }
      @keyframes blink { 0%, 60% { opacity: 1 } 61%, 100% { opacity: .25 } }

      /* === Startscreen === */
      #startscreen {
        position:fixed; inset:0; display:grid; place-items:center; z-index:10;
        background: radial-gradient(ellipse at center, rgba(11,16,32,.95), rgba(0,0,0,.88));
        color:#fff;
      }
      #startscreen .card {
        text-align:center; padding: 20px 22px; border: 1px solid var(--brand-3); border-radius: 12px;
        background: var(--brand-1); box-shadow: 0 10px 36px rgba(0,0,0,0.55);
        max-width: min(92vw, 640px); color:#fff;
      }
      #startscreen h1{ margin:0 0 8px; font-size:28px; letter-spacing:.5px; text-shadow:0 3px 8px rgba(0,0,0,.8); }
      #startscreen .sub{ opacity:.9; margin-top:6px; font-size:14px; }
      .speedbar{ display:flex; gap:8px; justify-content:center; margin-top:10px; flex-wrap:wrap; }
      .spdbtn{
        padding:8px 12px; font-size:16px; cursor:pointer;
        background:#2b2f55; border:1px solid #8aa3ff; border-radius:999px; color:#fff;
        box-shadow: 0 6px 16px rgba(138,163,255,.22), inset 0 -2px 0 rgba(0,0,0,.15);
      }
      .spdbtn.active{ outline:2px solid #8aa3ff; background:#30366b; }
      #startBtn{
        padding:10px 16px; font-size:18px; cursor:pointer; margin-top:12px;
        background:#2b2f55; border:1px solid #8aa3ff; border-radius:8px; color:#fff;
        box-shadow: 0 8px 20px rgba(138,163,255,.22), inset 0 -2px 0 rgba(0,0,0,.15);
      }
      #startBtn:hover{ transform: translateY(-1px); box-shadow: 0 10px 26px rgba(138,163,255,.32), inset 0 -2px 0 rgba(0,0,0,.18); }
    </style>
  </head>
  <body>
    <div id="hud">Score: <span id="score">0</span> | Space/‚Üë/Click = Jump</div>
    <div id="rec"><span class="dot"></span>REC</div>
    <div id="hint">developed by <code>Het Spectrum Gent</code></div>

    <!-- Game Over overlay -->
    <div id="gameover" role="dialog" aria-modal="true">
      <div class="card">
        <h1>GAME OVER</h1>
        <p class="score">Score: <span id="finalScore">0</span></p>
        <p>Leer Programmeren bij</p>
        <a class="cta-opleiding" href="https://scholen.stad.gent/spectrum/df-applicatie-en-databeheer-5ad-en-6ad" target="_blank" rel="noopener">üëâ Het Spectrum Gent ‚Äî Opleiding Applicatie &amp; Databeheer</a>
        <div style="margin-top:10px">
          <button id="copyCaption" class="minibtn">Copy caption + hashtags</button>
          <button id="shareSeed" class="minibtn" style="margin-left:6px">Copy challenge link</button>
        </div>
        <div id="tagbar" class="tagbar"></div>
        <p class="hint">Klik of druk op spatie om opnieuw te starten</p>
      </div>
    </div>

    <canvas id="c"></canvas>

    <!-- Startscreen -->
    <div id="startscreen">
      <div class="card">
        <h1>Pixel Jump ‚Ä¢ play!</h1>
        <div class="sub">Space / Click / ‚Üë om te springen ‚Ä¢ Seed: <span id="seedValue">‚Äî</span></div>
        <div class="speedbar" id="speedbar">
          <button class="spdbtn" data-speed="2.4">üê¢ Turtle</button>
          <button class="spdbtn" data-speed="3.0">üêá Rabbit</button>
          <button class="spdbtn" data-speed="3.8">üêÜ Leopard</button>
        </div>
        <button id="startBtn">‚ñ∂ Start</button>
      </div>
    </div>

    <script>
    'use strict';

    // ===== URL Params / RNG =====
    const params = new URLSearchParams(location.search);
    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
    const SEED = params.get('seed') ? parseInt(params.get('seed'),10) : (Math.random()*1e9)|0;
    let rand = mulberry32(isFinite(SEED) ? SEED : 1);

    // ===== Startscreen wiring =====
    const startScreen = document.getElementById("startscreen");
    const startBtn = document.getElementById("startBtn");
    const seedValueEl = document.getElementById("seedValue");
    const speedbar = document.getElementById("speedbar");
    seedValueEl.textContent = isFinite(SEED) ? SEED : '‚Äî';

    const HARD = params.get('hard') === '1';
    const SPEED_PARAM = parseFloat(params.get('speed'));
    const BASE_SCROLL_FALLBACK = HARD ? 3.8 : 3.0;
    let chosenSpeed = Number.isFinite(SPEED_PARAM) ? SPEED_PARAM : null;
    function updateActiveButtons(){
      document.querySelectorAll('.spdbtn').forEach(b=>{
        const s = parseFloat(b.dataset.speed);
        b.classList.toggle('active', chosenSpeed === s);
      });
    }
    speedbar.addEventListener('click', (e)=>{
      const b = e.target.closest('.spdbtn');
      if(!b) return;
      chosenSpeed = parseFloat(b.dataset.speed);
      updateActiveButtons();
    });
    updateActiveButtons();

    startBtn.addEventListener("click", ()=>{
      startScreen.style.display="none";
      start();
    });

    // ===== Canvas setup =====
    const canvas = document.getElementById('c');
    const ctx = canvas.getContext('2d');
    let W, H;
    function resize(){ W = canvas.width = innerWidth; H = canvas.height = innerHeight; }
    addEventListener('resize', resize); resize();

    // ===== Helpers =====
    function pick(arr){ return arr[(rand()*arr.length)|0]; }
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const randRange = (a,b) => a + rand()*(b-a);

    // ===== Themes =====
    const THEMES = {
      default:  {bg:'#0f1326', plat:'#3ef4a3', player:'#e6e6e6', filter:'none', banner:'#2b2f55', border:'#8aa3ff', star:'#ffffff'},
      retro:    {bg:'#0b0b0b', plat:'#39ff14', player:'#e8e4cf', filter:'contrast(1.15) saturate(0.9)', banner:'#1c1c1c', border:'#86ffb6', star:'#eaeaea'},
      sigma:    {bg:'#0b1220', plat:'#7cc7ff', player:'#ffffff', filter:'grayscale(1) contrast(1.25)', banner:'#101828', border:'#9ac7ff', star:'#dfe8ff'},
      skibidi:  {bg:'#120b1a', plat:'#ff61d8', player:'#ffffff', filter:'hue-rotate(20deg) saturate(1.2)', banner:'#2b0f2e', border:'#ff9dee', star:'#ffe6f8'},
      minecraft:{bg:'#1a2a16', plat:'#7dbb54', player:'#f5f1e6', filter:'contrast(1.2)', banner:'#2a3b1d', border:'#b0e38a', star:'#e9f8db'},
      f1:       {bg:'#0a0a0a', plat:'#e10600', player:'#f5f5f5', filter:'contrast(1.3)', banner:'#161616', border:'#ff5e5e', star:'#ffffff'},
      nasa:     {bg:'#03040a', plat:'#2b6cff', player:'#f1f7ff', filter:'brightness(1.05)', banner:'#0b1640', border:'#a9c4ff', star:'#dfe9ff'},
    };
    const THEME_NAME = (params.get('trend')||'default').toLowerCase();
    const BASE = THEMES[THEME_NAME] || THEMES.default;

    const RETRO_PALETTES = [
      {name:'crt', bg:'#111016', plat:'#39ff14', player:'#f4f4f4', banner:'#1a1a1a', border:'#86ffb6', filter:'contrast(1.05)'},
      {name:'neon', bg:'#0b0d1a', plat:'#ff61d8', player:'#ffffff', banner:'#201235', border:'#ff9dee', filter:'saturate(1.2)'},
      {name:'vapor', bg:'#1a1224', plat:'#7cc7ff', player:'#ffe5ff', banner:'#1c1730', border:'#9ac7ff', filter:'brightness(1.05)'},
      {name:'greenscr', bg:'#00190c', plat:'#39ff14', player:'#e8ffe8', banner:'#00130a', border:'#86ffb6', filter:'contrast(1.1)'},
      {name:'amber', bg:'#1a1300', plat:'#ffb000', player:'#fff3d0', banner:'#291f00', border:'#ffd36a', filter:'contrast(1.08)'},
      {name:'candy', bg:'#161018', plat:'#ff79c6', player:'#f8f8f2', banner:'#221324', border:'#ffb3e1', filter:'saturate(1.15)'},
      {name:'dusk',  bg:'#0f1326', plat:'#7df9ff', player:'#e6e6e6', banner:'#101b3a', border:'#b3ecff', filter:'brightness(1.06)'},
      {name:'cobalt',bg:'#061222', plat:'#2b6cff', player:'#f1f7ff', banner:'#0b1640', border:'#a9c4ff', filter:'brightness(1.05)'}
    ];

    let ACTIVE = {...BASE};
    function applyTheme(th){
      ACTIVE = {...ACTIVE, ...th};
      document.body.style.filter = ACTIVE.filter || 'none';
      document.documentElement.style.setProperty('--hud-border', ACTIVE.border || '#3a3a3a');
    }
    applyTheme(BASE);

    // ===== Tags/Captions =====
    const TREND_TAGS = (params.get('tags')?.split(',') || [
      '#BeatMyScore','#DuetThis','#Streak','#Speedrun','#OneMoreTry','#Retro','#PixelArt','#HTML5Game', 'SpaceGame', 'Gent', 'Belgium', 'Spectrum Gent', 'Programmeren'
    ]).slice(0,10);
    const CAPTIONS = [
      'Beat my SEED op TikTok :)',
      'Duet met je highscore!',
      'Kun jij dit level halen zonder te vallen? üî•',
    ];
    const REC  = params.get('rec') === '1';
    if (REC) document.getElementById('rec').style.display = 'inline-block';

    const tagbar = document.getElementById('tagbar');
    (function renderChips(){
      const colors = ['c1','c2','c3','c4','c5'];
      TREND_TAGS.forEach((t,i)=>{
        const span = document.createElement('span');
        span.className = 'chip ' + colors[i % colors.length];
        span.textContent = t;
        tagbar.appendChild(span);
      });
    })();

    // ===== UI (copy/share) =====
    const overlay = document.getElementById('gameover');
    const finalScoreEl = document.getElementById('finalScore');
    const btnCaption = document.getElementById('copyCaption');
    const btnShare   = document.getElementById('shareSeed');

    let CURRENT_BASE_SPEED = Number.isFinite(SPEED_PARAM) ? SPEED_PARAM : (HARD ? 3.8 : 3.0);

    function buildCaption(){
      const line = pick(CAPTIONS);
      const tags = TREND_TAGS.join(' ');
      return `${line} | Score: ${score} | Seed: ${SEED}\n${tags}`;
    }
    btnCaption?.addEventListener('click', async ()=>{
      try{ await navigator.clipboard.writeText(buildCaption()); btnCaption.textContent='‚úì Copied!'; setTimeout(()=>btnCaption.textContent='Copy caption + hashtags',1200);}catch{}
    });
    btnShare?.addEventListener('click', async ()=>{
      const url = new URL(location.href);
      url.searchParams.set('seed', String(SEED));
      url.searchParams.set('trend', THEME_NAME);
      if (HARD) url.searchParams.set('hard','1');
      if (Number.isFinite(CURRENT_BASE_SPEED)) url.searchParams.set('speed', String(CURRENT_BASE_SPEED));
      try{ await navigator.clipboard.writeText(url.toString()); btnShare.textContent='‚úì Link copied!'; setTimeout(()=>btnShare.textContent='Copy challenge link',1200);}catch{}
    });

    // ===== Audio =====
    let audioCtx = null, audioReady = false;
    function ensureAudio(){
      try{
        if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        if(audioCtx.state==='suspended') audioCtx.resume();
        audioReady=true;
      }catch(e){ audioReady=false; }
    }
    function beep({freq=800,dur=0.08,type='square',gain=0.15}={}){
      if(!audioReady) return;
      const o=audioCtx.createOscillator(),g=audioCtx.createGain();
      o.type=type; o.frequency.value=freq; g.gain.value=gain; o.connect(g).connect(audioCtx.destination);
      const now=audioCtx.currentTime; o.start(now);
      g.gain.setValueAtTime(gain,now); g.gain.exponentialRampToValueAtTime(0.001,now+dur);
      o.stop(now+dur+0.01);
    }
    function sfxJump(){ beep({freq:900,dur:0.06,gain:0.18}); setTimeout(()=>beep({freq:1200,dur:0.05,gain:0.14}),35); }
    function sfxCrash(){
      if(!audioReady) return;
      const now = audioCtx.currentTime;
      const o1 = audioCtx.createOscillator(); const o2 = audioCtx.createOscillator(); const g1 = audioCtx.createGain();
      o1.type='square'; o2.type='triangle';
      o1.frequency.setValueAtTime(800, now); o1.frequency.exponentialRampToValueAtTime(90, now + 0.35);
      o2.frequency.setValueAtTime(1200, now); o2.frequency.exponentialRampToValueAtTime(120, now + 0.35);
      g1.gain.setValueAtTime(0.28, now); g1.gain.exponentialRampToValueAtTime(0.0001, now + 0.38);
      o1.connect(g1); o2.connect(g1); g1.connect(audioCtx.destination); o1.start(now); o2.start(now); o1.stop(now+0.4); o2.stop(now+0.4);
      const durNoise = 0.25; const noiseBuf = audioCtx.createBuffer(1, audioCtx.sampleRate * durNoise, audioCtx.sampleRate);
      const data = noiseBuf.getChannelData(0); for (let i=0;i<data.length;i++) data[i]=(Math.random()*2 - 1)*(1 - i/data.length);
      const noise = audioCtx.createBufferSource(); noise.buffer=noiseBuf;
      const lp = audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.setValueAtTime(1200, now); lp.frequency.exponentialRampToValueAtTime(220, now + 0.25);
      const gN = audioCtx.createGain(); gN.gain.setValueAtTime(0.35, now + 0.02); gN.gain.linearRampToValueAtTime(0.0001, now + 0.27);
      noise.connect(lp).connect(gN).connect(audioCtx.destination); noise.start(now + 0.02); noise.stop(now + 0.30);
      const hit = audioCtx.createOscillator(); const g2  = audioCtx.createGain();
      hit.type='square'; hit.frequency.setValueAtTime(180, now + 0.32); hit.frequency.exponentialRampToValueAtTime(60,  now + 0.52);
      g2.gain.setValueAtTime(0.18, now + 0.32); g2.gain.exponentialRampToValueAtTime(0.0001, now + 0.55);
      hit.connect(g2).connect(audioCtx.destination); hit.start(now + 0.32); hit.stop(now + 0.56);
    }
    function sfxChirp(){ beep({freq:2200,dur:0.03,gain:0.07}); setTimeout(()=>beep({freq:2600,dur:0.035,gain:0.06}),45); }
    function sfxMotivate(){ beep({freq:1400,dur:0.05,gain:0.18}); setTimeout(()=>beep({freq:1800,dur:0.05,gain:0.16}),45); }
    function sfxLevel(){ beep({freq:880,dur:0.05,gain:0.20}); setTimeout(()=>beep({freq:1175,dur:0.06,gain:0.18}),60); setTimeout(()=>beep({freq:1568,dur:0.07,gain:0.16}),120); }
    function primeAudio(){ ensureAudio(); removeEventListener('pointerdown',primeAudio); removeEventListener('keydown',primeAudio); }
    addEventListener('pointerdown',primeAudio,{once:true});
    addEventListener('keydown',primeAudio,{once:true});

    // ===== Clouds =====
    const CLOUD_SPEED = 1.15;
    const MSGS = ["LEER GAMES MAKEN BIJ HET SPECTRUM GENT","PROGRAMMEER BIJ HET SPECTRUM GENT"];
    function makeCloud(x,y,scale=1,text=null){
      const baseR=14, puff=[[0,0,baseR*1.1],[-16,4,baseR*0.9],[16,6,baseR*0.95],[-6,-8,baseR*0.85],[10,-10,baseR*0.8]];
      return { x,y,scale,text,puff };
    }
    function roundRectPath(ctx,x,y,w,h,r){
      const rr=Math.min(r,w*0.5,h*0.5);
      ctx.beginPath(); ctx.moveTo(x+rr,y);
      ctx.lineTo(x+w-rr,y); ctx.quadraticCurveTo(x+w,y,x+w,y+rr);
      ctx.lineTo(x+w,y+h-rr); ctx.quadraticCurveTo(x+w,y+h,x+w-rr,y+h);
      ctx.lineTo(x+rr,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-rr);
      ctx.lineTo(x,y+rr); ctx.quadraticCurveTo(x,y,x+rr,y);
    }
    function drawCloudBanner(c){
      const bannerScale=Math.min(1.9,Math.max(1,c.scale+0.1));
      const padX=8*bannerScale, padY=5*bannerScale, fontSize=11*bannerScale;
      ctx.save(); ctx.translate(30*c.scale,-20*c.scale);
      ctx.font=`700 ${fontSize|0}px monospace`;
      ctx.textBaseline='top';
      ctx.shadowColor='rgba(0,0,0,0.6)'; ctx.shadowBlur=6;
      const text = c.text || pick(['DUET: BEAT THIS SEED','LEER CODEN IN 15s','SIGMA JUMP? TRY IT','RETRO MODE üîÅ','NO MISS STREAK üî•']);
      const textW=ctx.measureText(text).width;
      const w=textW+padX*2, h=fontSize+padY*2, r=5*bannerScale;
      ctx.fillStyle='rgba(0,0,0,0.35)'; roundRectPath(ctx,2,2,w,h,r); ctx.fill();
      ctx.fillStyle=ACTIVE.banner; roundRectPath(ctx,0,0,w,h,r); ctx.fill();
      ctx.lineWidth=Math.max(1,1.4*bannerScale); ctx.strokeStyle=ACTIVE.border; roundRectPath(ctx,0,0,w,h,r); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(12*bannerScale,h); ctx.lineTo(18*bannerScale,h); ctx.lineTo(15*bannerScale,h+6*bannerScale); ctx.closePath();
      ctx.fillStyle=ACTIVE.banner; ctx.fill(); ctx.strokeStyle=ACTIVE.border; ctx.stroke();
      ctx.fillStyle='#ffffff'; ctx.fillText(text,padX,padY);
      ctx.restore();
    }
    function drawCloud(c){
      ctx.save(); ctx.translate(c.x|0,c.y|0); ctx.scale(c.scale,c.scale);
      const fill='rgba(235,245,255,0.95)';
      ctx.beginPath();
      for(const [px,py,r] of c.puff){ ctx.moveTo(px+r,py); ctx.arc(px,py,r,0,Math.PI*2); }
      ctx.fillStyle=fill; ctx.fill();
      ctx.lineJoin='round'; ctx.lineCap='round'; ctx.lineWidth=0.8; ctx.strokeStyle=fill; ctx.stroke();
      ctx.beginPath();
      for(const [px,py,r] of c.puff){ ctx.moveTo(px+r,py); ctx.arc(px,py,r*0.92,Math.PI*1.05,Math.PI*1.95); }
      ctx.strokeStyle='rgba(255,255,255,0.30)'; ctx.lineWidth=1; ctx.stroke();
      if(c.text) drawCloudBanner(c);
      ctx.restore();
    }
    function spawnCloud(offscreenRight=true){
      const x=offscreenRight?W+60+rand()*140:rand()*W;
      const y=H*(0.14+rand()*0.30);
      const scale=0.9+rand()*1.0;
      const text=rand()<0.22?MSGS[(rand()*MSGS.length)|0]:null;
      clouds.push(makeCloud(x,y,scale,text));
    }

    // ===== Birds =====
    const BIRD_MIN_Y=0.35, BIRD_MAX_Y=0.55;
    function spawnBird(offscreenRight=true){
      const x=offscreenRight?W+40+rand()*120:rand()*W;
      const y=H*(BIRD_MIN_Y+rand()*(BIRD_MAX_Y-BIRD_MIN_Y));
      const speed=2+rand()*0.8; const seed=(rand()*1024)|0; const nextChirpFrame=t+30+((rand()*60)|0);
      birds.push({x,y,speed,seed,nextChirpFrame});
    }
    function updateAndDrawBirds(){
      for(let i=birds.length-1;i>=0;i--){
        const b=birds[i];
        if(!gameOver) b.x-=b.speed;
        if(!gameOver && audioReady && b.x>0 && b.x<W && t>=b.nextChirpFrame){
          sfxChirp(); b.nextChirpFrame=t+50+((rand()*80)|0);
        }
        const wingUp=(((t+b.seed)>>3)&1)===0;
        ctx.save(); ctx.translate(b.x|0,b.y|0);
        ctx.fillStyle='#f0f0f0'; ctx.fillRect(-6,-3,12,6);
        ctx.fillRect(3,-4,5,5);
        ctx.fillStyle='#111'; ctx.fillRect(6,-2,1,1);
        ctx.fillStyle='#ffc866'; ctx.fillRect(8,-1,3,2);
        ctx.fillStyle='#d9d9d9'; if(wingUp) ctx.fillRect(-3,-9,6,7); else ctx.fillRect(-3,2,6,7);
        ctx.restore();
        if(b.x<-60) birds.splice(i,1);
      }
      if(!birds.length || birds[birds.length-1].x < W-320){
        if(rand()<0.03) spawnBird(true);
      }
    }

    // ===== Streak & Popups =====
    const STREAK_EMOJIS = ["üí•","‚ö°","üöÄ","üåå","üé∏","üëæ","üïπÔ∏è","üìü","üõ∏","ü§Ø"];
    let lastEmoji = null;
    function pickStreakEmoji(streak){
      let e = STREAK_EMOJIS[(rand()*STREAK_EMOJIS.length)|0];
      if (e === lastEmoji && STREAK_EMOJIS.length > 1) e = STREAK_EMOJIS[((rand()*STREAK_EMOJIS.length)|0 + 1) % STREAK_EMOJIS.length];
      lastEmoji = e;
      if (streak >= 5 && rand() < 0.20) {
        let e2 = STREAK_EMOJIS[(rand()*STREAK_EMOJIS.length)|0];
        if (e2 === e && STREAK_EMOJIS.length > 1) e2 = STREAK_EMOJIS[((rand()*STREAK_EMOJIS.length)|0 + 1) % STREAK_EMOJIS.length];
        return { text: e + " " + e2, combo: true };
      }
      return { text: e, combo: false };
    }
    const MOTOS = [
      "‚ú® PERFECT!","üî• You are nailing it","üí™ Yes you can","üòé Ok√© Jos√©",
      "üéØ Keep it rolling","üß† Big brain moves","üöÄ Speedrun vibes","ü•∑ Clean jumps!"
    ];

    // ===== Game state =====
    const scoreEl = document.getElementById('score');
    const player = { x: 80, y: 0, vy: 0, r: 16, onGround: false };
    const gravity = 0.7, jumpVY = -12;
    let t = 0, score = 0, level = 1;
    let lastWasHardGap = false;
    let gameOver = false;
    let platforms = [], clouds = [], birds = [];
    let streak = 0;
    let popups = [];
    let platformIdCounter = 1;
    let lastCountedPlatformId = 0;
    let lastGap = null; // onthoud de vorige gap om grote variatie af te dwingen

    function addPopup(msg,x,y,style='normal'){ popups.push({msg,x,y,age:0,style}); }

    // Glow
    let platFlash = 0, platFlashHue = 0;
    function triggerFlash(strength=1, hueRand=true){
      platFlash = Math.max(platFlash, strength);
      if (hueRand) platFlashHue = (rand()*360)|0;
    }

    // Palette switch (bij level-up)
    let lastPaletteName = null;
    function switchRetroPalette(){
      let p = pick(RETRO_PALETTES);
      if (p.name === lastPaletteName && RETRO_PALETTES.length > 1){
        p = RETRO_PALETTES[(RETRO_PALETTES.indexOf(p)+1)%RETRO_PALETTES.length];
      }
      lastPaletteName = p.name;
      applyTheme(p);
      triggerFlash(1.0, true);
      addPopup('üé® PALETTE SHIFT!', player.x-30, Math.max(28, player.y-72), 'perfect');
    }

    // ===== Nieuwe eisen =====
    // Snelheid: +10% per level (i.p.v. 5%)
    function currentScroll(){ return CURRENT_BASE_SPEED * Math.pow(1.10, (level - 1)); }

    // Gaps schalen zachtjes met level (max +30%)
    function levelGapMultiplier(){
      return Math.min(1.3, 1 + 0.10 * (level - 1)); // L1:1.00, L2:1.10, L3:1.20, L4+:1.30
    }

    // ===== Sprongfysica en gap-berekening =====
    function timeToReachDeltaY(deltaY){
      const g = gravity, vy0 = jumpVY;         // jumpVY < 0
      const disc = vy0*vy0 + 2*g*deltaY;
      if (disc < 0) return 0;
      const tHit = (-vy0 + Math.sqrt(disc)) / g;   // neerwaartse wortel
      const tMax = (-2*vy0) / g;                   // terug op start-hoogte
      return Math.max(0, Math.min(tHit, tMax));
    }

    // VERVANG targetGap(...) door:
    function computeGap(prev, nextY, scr, nextW){
    // tijd tot landen o.b.v. hoogteverschil
    const tLand   = Math.max(0.25, timeToReachDeltaY(nextY - prev.y));
    const reach   = scr * tLand;                 // horizontale ‚Äúwereldverplaatsing‚Äù t/m landing
    const lvlMul  = Math.min(1.15, 1 + 0.05*(level - 1)); // veel zachtere level-schaal

    // STRAKKERE MAX: kleiner dan fysiek kan om ‚Äúte grote‚Äù gaps te vermijden
    // (0.65*reach + 0.35*nextW) is conservatiever dan je vorige formule
    const MAX     = Math.max(68, (0.65*reach + 0.35*nextW)) * lvlMul;

    // lager minimum zodat het niet te triviaal is maar duidelijk kleiner blijft
    const MIN     = 48;

    // Variatie in ‚Äútientallen %‚Äù met drie banden, maar bewust lager getuned
    function sampleTier(){
        const r = rand();
        if (r < 0.55) return randRange(0.65, 0.80);  // klein
        if (r < 0.92) return randRange(0.81, 0.92);  // midden
        return randRange(0.93, 0.98);                // spicy, maar nog compact
    }

    // basis-sample
    let gap = MAX * sampleTier();

    // verschil t.o.v. vorige gap afdwingen (‚â•15%) om zichtbaar te vari√´ren
    let tries = 0;
    while (lastGap !== null && tries < 4) {
        const rel = Math.abs(gap - lastGap) / Math.max(1, lastGap);
        if (rel >= 0.15) break;
        gap = MAX * sampleTier();
        tries++;
    }

    // lichte jitter voor natuurlijke spreiding (max ¬±12%)
    const jitterPct = Math.min(0.12, 0.08 + 0.01*(level - 1));
    gap *= (1 + (rand()*2 - 1) * jitterPct);

    // afronden + begrenzen
    gap = clamp(gap, MIN, MAX) | 0;
    lastGap = gap;
    return gap;
    }


    // ===== Level reset + initi√´le platforms =====
    function reset(){
      score=0; scoreEl.textContent=score;
      platforms=[]; clouds=[]; birds=[]; lastWasHardGap=false;
      platformIdCounter = 1;
      lastCountedPlatformId = 0;

      for(let i=0;i<6;i++) spawnCloud(false);
      for(let i=0;i<2;i++) spawnBird(false);

      const baseY=H*0.58, baseX=player.x-60;

      // Startplatform (extra lang)
      const startPlat = {id:platformIdCounter++, x:baseX,y:baseY,w:360,h:10};
      platforms.push(startPlat);

      player.y=baseY-player.r; player.vy=0; player.onGround=true;
      lastCountedPlatformId = startPlat.id; // startplatform telt niet

      // Volgende platforms met gevarieerde breedtes en gaps
      let prev = startPlat;
      for(let i=1;i<8;i++){
        const w = (95 + (rand()*70)|0);
        const vertAmp = (CURRENT_BASE_SPEED <= 2.6 ? 18 : 26);
        const y = clamp(
          prev.y + Math.sin(i*0.55)*vertAmp + (rand()*vertAmp - vertAmp/2),
          H*0.50, H*0.80
        );

        const scr = CURRENT_BASE_SPEED;
        const gap = computeGap(prev, y, scr, w);

        const x = prev.x + prev.w + gap;
        const p = {id:platformIdCounter++, x, y, w, h:10};
        platforms.push(p);
        prev = p;
      }

      applyTheme(BASE);
      level = 1;
      streak = 0;
      platFlash = 0;
      lastPaletteName = null;
    }

    // ===== Generator voor volgende platform =====
    function nextPlatform(prev){
      const wantHard = !lastWasHardGap && (CURRENT_BASE_SPEED > 3.2 ? rand()<0.22 : rand()<0.12);
      const baseAmp = (CURRENT_BASE_SPEED <= 2.6 ? 16 : 24);
      const y = clamp(
        prev.y + (wantHard ? (rand()*baseAmp - baseAmp/2)
                           : (Math.sin(t*0.06+rand())*baseAmp + (rand()*baseAmp - baseAmp/2))),
        H*0.50, H*0.80
      );

      // Breedte vari√´ren per platform
      const w = (90 + (rand()*80)|0);

        const scr = currentScroll();
        const gap = computeGap(prev, y, scr, w);


      lastWasHardGap = wantHard;
      return { x: prev.x + prev.w + gap, y, w };
    }

    function spawn(){
      const last=platforms[platforms.length-1];
      const np=nextPlatform(last);
      platforms.push({id:platformIdCounter++, x:np.x,y:np.y,w:np.w,h:10});
      if(platforms.length>10) platforms.shift();
    }

    // ===== Controls =====
    function jump(){
      if(gameOver){ hideGameOver(); reset(); return; }
      if(player.onGround){
        player.vy=jumpVY; player.onGround=false; sfxJump();
      }
    }
    addEventListener('keydown',e=>{ if(e.code==='Space'|| e.code === 'ArrowUp') jump(); });
    canvas.addEventListener('pointerdown', ()=>{ jump(); }, {passive:true});

    // ===== Game Over + HUD =====
    function showGameOver(){ gameOver = true; finalScoreEl.textContent = score; overlay.style.display = 'grid'; }
    function hideGameOver(){
      overlay.style.display = 'none';
      gameOver = false;
      streak = 0;
      level = 1;
      platFlash = 0;
      applyTheme(BASE);
      lastPaletteName = null;
    }
    (function adjustHUD(){
      document.documentElement.style.setProperty('--hud-bg', 'rgba(0,0,0,.55)');
      document.documentElement.style.setProperty('--hud-text', '#ffffff');
      document.documentElement.style.setProperty('--hint-text', '#ffffff');
    })();

    // ===== Main loop =====
    let prevOnGround = true;
    let lastTS = performance.now();

    function loop(ts){
      if (ts === undefined) ts = performance.now();
      const dt = Math.min(50, ts - lastTS) / 16.6667;
      lastTS = ts;

      t += dt;

      if(!gameOver){
        const wasOnGround = prevOnGround;

        // physics
        player.vy += gravity * dt;
        player.y  += player.vy * dt;

        // clouds
        for(const c of clouds) c.x -= CLOUD_SPEED * (0.85 + (c.scale - 1) * 0.35) * dt;
        while(clouds.length && clouds[0].x < -260) clouds.shift();
        if(!clouds.length || clouds[clouds.length-1].x < W-260){ if(rand()<0.6*dt) spawnCloud(true); }

        // scroll (10% sneller per level)
        const SCROLL = currentScroll();
        for (const p of platforms) p.x -= SCROLL * dt;

        // spawn nieuwe platforms als de eerste weg is
        if(platforms[0].x + platforms[0].w < 0){ spawn(); }

        // collision + landing detectie
        let platformUnderfoot = null;
        player.onGround = false;
        for(const p of platforms){
          if(player.x > p.x - player.r && player.x < p.x + p.w + player.r){
            if(player.y + player.r > p.y && player.y + player.r < p.y + p.h + 10 && player.vy >= 0){
              player.y = p.y - player.r; player.vy = 0; player.onGround = true;
              platformUnderfoot = p;
              break;
            }
          }
        }

        // landing event
        if (player.onGround && !wasOnGround && platformUnderfoot) {
          if (platformUnderfoot.id !== lastCountedPlatformId) {
            score++; scoreEl.textContent = score;
            streak++;
            lastCountedPlatformId = platformUnderfoot.id;

            if (streak % 3 === 0) {
              const pickRes = (function(st){ let res; let e = STREAK_EMOJIS[(rand()*STREAK_EMOJIS.length)|0]; if (e === lastEmoji && STREAK_EMOJIS.length > 1) e = STREAK_EMOJIS[((rand()*STREAK_EMOJIS.length)|0 + 1) % STREAK_EMOJIS.length]; lastEmoji = e; if (st >= 5 && rand() < 0.20) { let e2 = STREAK_EMOJIS[(rand()*STREAK_EMOJIS.length)|0]; if (e2 === e && STREAK_EMOJIS.length > 1) e2 = STREAK_EMOJIS[((rand()*STREAK_EMOJIS.length)|0 + 1) % STREAK_EMOJIS.length]; res = { text: e + " " + e2, combo: true }; } else res = { text: e, combo: false }; return res; })(streak);
              addPopup(`${pickRes.text} STREAK x${streak}`, player.x+20, Math.max(40, player.y-40), 'streak');
              if (pickRes.combo) triggerFlash(0.55, true);
            }
            if (streak % 5 === 0) {
              addPopup(pick(MOTOS), player.x-18, Math.max(30, player.y-64), 'perfect');
              sfxMotivate();
              triggerFlash(0.7, true);
            }
            if (streak % 10 === 0) {
              level++;
              switchRetroPalette();
              sfxLevel();
              addPopup(`LEVEL ${level}`, player.x-28, Math.max(24, player.y-80), 'level');
              triggerFlash(1.2, true);
            }
          }
        }

        prevOnGround = player.onGround;

        // fail
        if(player.y > H + 100){ sfxCrash(); showGameOver(); }
      }

      // ===== Render =====
      ctx.clearRect(0,0,W,H);

      // bg + stars
      ctx.fillStyle = ACTIVE.bg; ctx.fillRect(0,0,W,H);
      for(let i=0;i<60;i++){
        ctx.fillStyle='rgba(255,255,255,0.07)';
        ctx.fillRect((i*73+t)%W,(i*37)%H,2,2);
      }

      // birds
      updateAndDrawBirds();

      // clouds
      for(const c of clouds) drawCloud(c);

      // platforms + glow
      ctx.save();
      if (platFlash > 0.01){
        ctx.shadowColor = `hsl(${platFlashHue}, 90%, 65%)`;
        ctx.shadowBlur  = 20 * platFlash;
      }
      ctx.fillStyle = ACTIVE.plat;
      for(const p of platforms) ctx.fillRect(p.x,p.y,p.w,p.h);
      ctx.restore();

      // player
      ctx.beginPath(); ctx.arc(player.x,player.y,player.r,0,Math.PI*2);
      ctx.fillStyle = ACTIVE.player; ctx.fill();
      ctx.lineWidth = 2; ctx.strokeStyle = 'rgba(0,0,0,0.35)'; ctx.stroke();

      // popups
      for(let i=popups.length-1;i>=0;i--){
        const p=popups[i];
        p.age++;
        const life = p.style==='level' ? 80 : p.style==='perfect' ? 72 : 60;
        const alpha = Math.max(0, 1 - p.age/life);
        const scale = 1 + Math.max(0, (12 - p.age) / 60);
        ctx.save();
        ctx.globalAlpha = alpha;
        ctx.translate(p.x, p.y - p.age*0.5);
        ctx.scale(scale, scale);
        let font = '700 16px monospace';
        let fill = '#ffffff';
        if (p.style==='perfect') { font='800 18px monospace'; fill='#ffe9a8'; }
        if (p.style==='level')   { font='800 20px monospace'; fill='#c7fff0'; }
        ctx.font = font;
        ctx.fillStyle = fill;
        ctx.strokeStyle = 'rgba(0,0,0,0.7)'; ctx.lineWidth=3;
        ctx.strokeText(p.msg, 0, 0);
        ctx.fillText(p.msg, 0, 0);
        ctx.restore();
        if(p.age>life) popups.splice(i,1);
      }

      // flash decay
      platFlash *= Math.pow(0.90, dt);

      requestAnimationFrame(loop);
    }

    function start(){
      CURRENT_BASE_SPEED = Number.isFinite(chosenSpeed) ? chosenSpeed
                         : Number.isFinite(SPEED_PARAM) ? SPEED_PARAM
                         : BASE_SCROLL_FALLBACK;
      hideGameOver();
      reset();
      lastTS = performance.now();
      loop();
    }
    // start via Start-knop

    // ===== Mini API =====
    const game = {
      get score(){ return score; },
      set score(v){ score = v|0; scoreEl.textContent = score; },
      flash(){ document.body.style.filter='invert(1) hue-rotate(180deg)'; setTimeout(()=>document.body.style.filter=ACTIVE.filter||'none',200); },
      seed: SEED, theme: THEME_NAME, hard: HARD
    };
    window.game = game;

    </script>
  </body>
</html>
